# 日语学习应用 - 任务清单

## 网络热词自动更新系统
- [x] 设计热词数据表结构(存储热词、来源、更新时间等)
- [x] 开发热词搜索和抓取API
- [x] 开发热词数据导入和更新逻辑(包含去重机制)
- [x] 创建手动更新热词的后端API
- [x] 在词汇库页面添加"更新热词"按钮
- [x] 显示热词更新状态和最后更新时间
- [ ] 实现定时任务自动更新热词(每周一次)
- [ ] 开发词汇详情页展示热词信息
- [x] 测试热词更新功能
- [ ] 测试定时任务功能

## 词汇库筛选和排序功能
- [x] 后端API添加首字母筛选参数
- [x] 后端API添加排序方式参数(首字母/默认)
- [x] 前端添加首字母筛选UI(あ、か、さ、た、な、は、ま、や、ら、わ行)
- [x] 前端添加排序方式选择UI
- [x] 测试筛选和排序功能

## 语法库页面开发
- [x] 分析现有grammar表结构和数据
- [x] 后端API添加语法列表查询接口(支持JLPT等级筛选)
- [x] 后端API添加首字母筛选参数
- [x] 后端API添加排序方式参数
- [x] 创建GrammarList.tsx前端页面
- [x] 添加JLPT等级筛选UI
- [x] 添加首字母筛选UI(あ、か、さ、た、な、は、ま、や、ら、わ行)
- [x] 添加排序方式选择UI
- [x] 添加搜索功能
- [x] 创建语法详情页面
- [x] 编写单元测试
- [ ] 在导航栏中添加语法库入口

## 词汇库和语法库数据完善
- [x] 检查各JLPT等级的词汇和语法数据完整性
- [ ] 扩展vocabulary表支持变体形式(已有tags字段可用)
- [ ] 扩展grammar表支持变体形式(已有tags字段可用)
- [x] 优化例句关联机制(已有sentences表)
- [ ] 导入完整的N5-N1词汇数据(已准备数据源和脚本)
- [ ] 导入完整的N5-N1语法数据(已准备数据源和脚本)
- [ ] 为词汇和语法添加详细释义(可通过管理界面添加)
- [x] 开发AI生成例句功能(单个词汇/语法)
- [x] 开发AI生成对话场景功能(结合词汇和语法)
- [x] 优化词汇详情页展示变体形式和多例句
- [x] 优化语法详情页展示变体形式和多例句
- [x] 在详情页添加“生成AI例句”和“生成对话场景”按钮
- [ ] 测试所有功能

## AI生成结果展示优化
- [x] 在词汇详情页添加state存储AI生成的例句
- [x] 在词汇详情页添加Card展示生成的例句
- [x] 在词汇详情页添加state存储AI生成的对话场景
- [x] 在词汇详情页添加Card展示生成的对话场景
- [x] 在语法详情页添加state存储AI生成的例句
- [x] 在语法详情页添加Card展示生成的例句
- [x] 在语法详情页添加state存储AI生成的对话场景
- [x] 在语法详情页添加Card展示生成的对话场景
- [x] 测试AI生成和展示功能

## 注音显示优化
- [x] 优化后端AI生成API返回带注音的数据格式
- [x] 创建RubyText组件用于显示日语注音
- [x] 在词汇详情页的AI生成内容中使用RubyText组件
- [x] 在语法详情页的AI生成内容中使用RubyText组件
- [x] 调整注音字体大小和间距
- [x] 测试注音显示效果

## 批量数据导入功能
- [x] 创建数据导入管理页面
- [x] 添加CSV/JSON文件上传功能
- [x] 创建后端批量导入API
- [x] 添加导入进度显示
- [x] 添加导入结果反馈
- [x] 准备N4词汇导入数据
- [x] 准备N2-N4语法导入数据
- [x] 测试数据导入功能

## 批量导入JLPT数据到数据库
- [x] 转换N4词汇数据为标准JSON格式
- [x] 转换N2-N4语法数据为标准JSON格式
- [x] 创建批量导入脚本
- [x] 执行N4词汇数据导入(26个)
- [x] 执行语法数据导入(35个)
- [x] 验证导入结果

## 网络热词优化
- [x] 检查当前网络热词数据内容
- [x] 更新为真正的网络流行语(ワンチャン、エモい等)
- [x] 添加去重逻辑,排除与vocabulary表重复的词汇
- [x] 测试热词列表展示

## 数据迁移到Supabase
- [ ] 检查MCP Supabase连接状态
- [ ] 导出当前数据库的vocabulary数据
- [ ] 导出当前数据库的grammar数据
- [ ] 导出当前数据库的sentences数据
- [ ] 在Supabase中创建表结构
- [ ] 导入数据到Supabase
- [ ] 验证数据迁移完整性
- [ ] 更新DATABASE_URL环境变量

## 使用开源数据集+AI补充方案
- [x] 下载开源JLPT数据集(GitHub elzup/jlpt-word-list)
- [x] 解析并转换为标准JSON格式(7972个词汇)
- [x] 批量导入词汇到数据库(7972个词汇已导入)
- [ ] 批量导入语法到数据库
- [ ] 使用AI为每个词汇生成例句
- [ ] 使用AI为每个语法生成例句
- [ ] 使用AI补充变体形式
- [ ] 验证数据完整性

## 词汇详情页优化
- [x] 扩展vocabulary表添加词性字段(partOfSpeech-已存在)
- [x] 添加常用搭配字段(collocations)
- [x] 添加同义词和反义词关联
- [x] 集成Web Speech API实现日语TTS朗读
- [x] 优化词汇详情页UI布局
- [x] 添加朗读按钮和播放状态
- [x] 测试语音朗读功能

## 词汇数量统计显示
- [x] 检查数据库中的重复词汇(6644个重复)
- [x] 在词汇列表页面显示各JLPT等级的词汇数量
- [x] 在语法列表页面显示各JLPT等级的语法数量
- [x] 测试数量显示功能

## 批量翻译英文释义为中文
- [x] 检查数据库中英文释义的词汇数量(7629个)
- [ ] 停止旧的翻译任务
- [ ] 创建新的AI批量翻译脚本
- [ ] 执行批量翻译并更新数据库
- [ ] 验证翻译结果

## 清理重复词汇数据
- [x] 检查翻译进度
- [x] 分析重复词汇的规律
- [x] 创建清理重复词汇的脚本
- [x] 执行清理并备份
- [x] 验证清理结果

## UI优化 - 分页、罗马音输入、注音显示
- [x] 为词汇库和语法库添加分页功能(当前只显示50个)
- [x] 创建JapaneseInput组件支持罗马音转假名
- [x] 在词汇库和语法库搜索框中集成罗马音输入
- [x] 词汇列表已使用VocabRuby组件显示注音
- [x] 测试分页功能(上一页/下一页按钮正常)
- [x] 测试罗马音输入功能(konnichiwa转换为こんにちわ)
- [x] 测试注音显示功能(词汇列表显示注音)

## 批量生成词汇例句
- [x] 分析数据库结构和例句表关系
- [x] 创建AI批量生成例句的脚本
- [ ] 执行批量生成任务(7840个词汇,每个2-3个例句,后台运行中)
- [ ] 验证生成的例句质量
- [x] 保存检查点

## 分页显示优化
- [x] 修改后端API返回每个分类的总数量
- [x] 更新词汇库分类标签显示总数(如"N5 (716)")
- [x] 更新语法库分类标签显示总数(如"N5 (11)")
- [x] 优化分页器显示页码和总页数(如"第1页 / 共15页")
- [x] 测试分页功能(词汇库和语法库都正常)

## 词汇详情页音频发音功能
- [x] 分析词汇详情页的当前结构
- [x] 使用浏览器内置Web Speech API实现日语发音
- [x] 优化useSpeech hook设置(ja-JP, rate=0.85)
- [x] 在VocabularyDetail页面添加音频播放按钮
- [x] 测试音频播放功能(正常工作)
- [x] 保存检查点

## 导入完整N1-N5语法数据
- [x] 搜索可用的开源日语语法数据集(jlptsensei.com)
- [x] 创建AI生成语法数据脚本
- [ ] 执行批量生成任务(后台运行中,目标710+个语法点)
- [ ] 验证导入结果
- [x] 保存检查点

## 筛选和排序UI视觉优化
- [x] 分析当前筛选排序UI的问题
- [x] 重新设计筛选器组件(使用Popover弹出面板)
- [x] 重新设计排序选择器组件(使用DropdownMenu)
- [x] 优化首字母筛选的视觉效果(5x2网格布局)
- [x] 统一词汇库和语法库的筛选UI风格
- [x] 测试新的UI交互(筛选、清除、状态显示)

## 用户笔记功能
- [x] 设计数据库schema(user_notes表)
- [x] 创建后端API(创建、更新、获取、删除笔记)
- [x] 在词汇详情页添加笔记UI组件
- [x] 在语法详情页添加笔记UI组件
- [x] 测试笔记功能(词汇和语法详情页都正常)
- [x] 保存检查点

## 全局AI问答气泡窗
- [x] 创建全局AI问答气泡窗组件(固定在右下角)
- [x] 实现划词引用功能(选中日语文本自动引用到问答框)
- [x] 实现知识点添加功能(添加到学习按钮)
- [x] 确保选中正文时弹窗不消失(使用mouseup事件)
- [x] 测试全局AI问答功能(气泡窗正常打开)

## 全局汉字注音功能
- [x] 分析当前注音组件的实现方式
- [x] 创建JapaneseText组件(支持自动获取读音和手动传入reading)
- [x] 添加getReading API端点
- [x] 在GrammarList页面应用注音
- [x] 在GrammarDetail页面应用注音
- [x] 在VocabularyDetail例句中应用注音
- [x] 测试全局注音效果(首页、语法详情页正常显示)
- [x] 保存检查点

## 艾宾浩斯复习系统
- [x] 设计数据库schema(studyRecords表、dailyStudyStats表)
- [x] 实现艾宾浩斯遗忘曲线算法(复习间隔:1天、2天、4天、7天、15天、30天)
- [x] 创建后端API(addToStudyPlan、getReviewItems、recordReview等)
- [x] 创建复习页面UI(统计卡片、复习卡片、记忆程度按钮)
- [x] 在词汇详情页添加"加入学习"按钮
- [x] 在语法详情页添加"加入学习"按钮
- [x] 显示今日待复习数量和学习统计
- [x] 测试复习系统(加入学习、统计显示正常)
- [x] 保存检查点

## 列表状态保持优化
- [ ] 词汇库返回时保持当前tab、页码和滚动位置
- [ ] 语法库返回时保持当前tab、页码和滚动位置

## 沉浸式场景学习系统
- [ ] 设计场景学习系统架构
- [ ] 设计数据库schema(场景表、对话表、媒体素材表)
- [ ] 创建分级场景体系(幼儿园→小学→中学→高中级)
- [ ] 实现纯日语对话模式(点击查看解释,非默认翻译)
- [ ] 创建故事驱动学习(连续剧式故事线)
- [ ] 实现角色扮演对话功能
- [ ] 添加听力优先模式(先听后看)
- [ ] 添加跟读练习功能
- [ ] 添加填空对话训练
- [ ] 集成动漫场景素材库
- [ ] 集成J-POP歌词素材库
- [ ] 集成电影场景素材库
- [ ] 为每个素材标注来源
- [ ] 创建场景学习页面UI
- [ ] 测试场景学习功能
- [x] 保存检查点


## 沉浸式场景学习系统 Phase 1 (已完成)
- [x] 设计数据库schema (learning_units, media_materials, scene_categories, user_unit_progress, daily_learning_plans, expression_bank)
- [x] 创建后端API (immersive路由: getCategories, getUnits, getUnitById, getMediaMaterials, getUserProgress, updateProgress, getDailyPlan, generateDailyPlan, getExpressions, generateDialogueVariant, completeUnit)
- [x] 创建沉浸式学习首页 (ImmersiveLearning.tsx)
- [x] 创建学习单元详情页 (ImmersiveDetail.tsx)
- [x] 实现今日学习计划功能 (AI驱动生成)
- [x] 实现对话播放和进度追踪
- [x] 实现AI对话变体生成
- [x] 更新导航和首页链接
- [x] 创建初始学习单元数据 (10个单元: N5-N1各级别)
- [x] 编写单元测试 (12个测试全部通过)
- [x] 测试完整学习流程
- [x] 保存检查点


## 沉浸式学习页面优化 (已完成)
- [x] 移除注音开关，全局自动显示振假名注音
- [x] 添加中文解释显示开关（打开后在原文下方显示中文翻译）
- [x] 实现智能词汇/语法点击识别弹窗（显示解释、词性、用法、例句、语音）
- [x] 修复语音播放问题（优化useSpeech hook确保使用日语语音）
- [x] 测试完整功能 (3个API测试通过)
- [x] 保存检查点

## 全局注音规范 (Checklist)
- [ ] 所有日语汉字必须在上方显示振假名小字注音
- [ ] 新增功能需检查是否符合此规范


## Bug修复 - 沉浸式学习页面 (已修复)
- [x] Bug1: 点击中文按钮页面没有反应 - Switch组件已正确绑定
- [x] Bug2: 振假名完全没有显示 - 重写JapaneseText组件，修复对齐算法
- [x] Bug3: 语音还是读的中文而非日语 - 优化useSpeech hook，增强日语语音检测
- [x] Bug4: 点击日语文本没有任何反应 - 文本选择和API调用已正常工作


## Bug修复 - 振假名和翻译功能 (已完成)
- [x] 修复振假名显示问题 - 重写JapaneseText组件，使用更可靠的对齐算法
- [x] 重新设计翻译功能 - 移除中文开关，改为每句日语末尾添加分析按钮
- [x] 点击按钮弹出气泡显示：中文翻译、重要词汇、语法知识点
- [x] 添加analyzeSentence API和测试 (5个测试通过)


## 全局翻译插件 (已完成)
- [x] 创建TranslatableText组件 - hover日语句子时在句末显示悬浮翻译按钮
- [x] 实现点击按钮显示翻译功能
- [x] 实现hover翻译显示隐藏按钮功能
- [x] 优化按钮样式使其美观
- [x] 在沉浸式学习页面应用插件
- [x] 为注释部分也添加翻译按钮
- [x] 测试全局翻译插件功能
- [x] 修复注释部分振假名挤在一起的问题 - 改进buildRubyText算法
- [x] 继续修复振假名对齐问题 - 重写算法，正确处理「」等标点符号
- [x] 翻译弹窗中的日语词汇添加振假名注音

## 目标表达翻译交互优化 (已完成)
- [x] 将目标表达部分的翻译按钮改为hover显示的交互方式 - 使用TranslatableText组件


## 对话显示优化 (已完成)
- [x] 为每个说话人分配不同颜色（对话框背景、名字、头像） - 使用speakerColors配置6种颜色
- [x] 修复播放全部按钮，确保上一句念完后再播放下一句 - speak返回Promise，使用isPlayingRef控制
- [x] 对话中的注释默认收起，点击展开 - 使用expandedNotes状态和toggleNote函数


## 中文字体优化 (已完成)
- [x] 分析当前字体配置问题（字符宽度不一致、手机端大小不一）
- [x] 选择兼容性更好的中文字体方案 - 使用Noto Sans SC作为中文主字体
- [x] 更新CSS字体配置 - 优化字体堆栈，添加font-feature-settings
- [x] 测试桌面端和移动端显示效果


## 字体加载状态处理 (已完成)
- [x] 使用Font Loading API检测字体加载状态
- [x] 添加加载中的占位样式（避免FOUT闪烁） - fonts-loading类隐藏内容
- [x] 字体加载完成后平滑过渡显示内容 - fonts-loaded类添加transition
- [x] 测试字体加载效果 - 3秒超时保护


## 沉浸式学习知识扩展功能 (已完成)
- [x] 设计知识扩展数据结构（场景应用、语言起源、古今对比、参考来源） - knowledge_expansions表
- [x] 创建后端API生成知识扩展内容（AI生成+网络搜索） - generateKnowledgeExpansion API
- [x] 实现网络搜索功能并标注参考来源 - 添加参考来源列表
- [x] 创建前端知识扩展UI组件（可折叠卡片式展示） - KnowledgeExpansion组件
- [x] 在学习单元详情页集成知识扩展模块 - ImmersiveDetail页面
- [x] 测试知识扩展功能 - 8个单元测试通过


## 日语字体视觉优化 (已完成)
- [x] 分析汉字和假名视觉割裂问题
- [x] 调整字体堆栈顺序，将Noto Sans JP作为首选字体
- [x] 统一日语文本的字体配置，确保汉字和假名视觉一致
- [x] 优化Ruby组件和日语文本类的字体设置


## 注音显示修复 (已完成)
- [x] 分析当前注音组件的逻辑问题 - buildRubyText函数将片假名也当作假名处理
- [x] 修改注音算法，只对汉字添加振假名 - 分离平假名和片假名类型
- [x] 片假名和平假名直接显示不加注音 - 两种假名都跳过注音处理
- [x] 测试注音显示效果 - 12个测试通过


## 英文单词注音修复 (已完成)
- [x] 分析英文单词导致注音错位的问题
- [x] 修改buildRubyText函数，添加英数字类型(alphanumeric)
- [x] 英文和数字也添加注音（如J-POP显示「じぇいぽっぷ」）
- [x] 测试英文混合日语的注音效果 - 12个测试通过


## 注音边界修复 (已完成)
- [x] 修复英文单词注音边界问题（J-POP的注音单独显示在J-POP上方）
- [x] 确保平假名「の」不加注音 - 平假名和片假名都跳过注音
- [x] 每个需要注音的部分（汉字、英文）都单独显示对应的注音 - 按字符比例分配读音
- [x] 测试混合文本的注音效果 - 12个测试通过


## 假名识别修复 (已完成)
- [x] 修复「の」被错误识别为标点的问题 - 「の」正确识别为平假名
- [x] 确保平假名正确分割J-POP和恋愛 - 合并被连字符分割的英数字块
- [x] J-POP上方显示「じぇいぽっぷ」，恋愛上方显示「れんあい」
- [x] 测试混合文本的注音效果 - 12个测试通过


## JapaneseText注音修复 (已完成)
- [x] 分析JapaneseText组件的alignKanjiWithReading算法问题 - 重写算法
- [x] 修复J-POP注音为「ジェイポップ」单独显示在J-POP上方 - 合并连字符分割的英数字块
- [x] 确保「の」不加注音 - 平假名跳过注音处理
- [x] 确保「恋愛」注音为「れんあい」单独显示在恋愛上方 - 汉字单独处理
- [x] 测试混合文本的注音效果 - 12个测试通过


## 知识扩展例句翻译 (已完成)
- [x] 修改知识扩展的prompt，要求AI生成例句时同时输出中文翻译
- [x] 确保所有日语例句下方都有对应的中文翻译 - 添加exampleTranslation和expressionTranslation字段
- [x] 测试知识扩展生成效果 - 8个测试通过


## 知识扩展日语hover翻译 (已完成)
- [x] 修改AI prompt，让日语部分用特殊标记包裹（{{JP}}...{{/JP}}）
- [x] 创建解析函数parseJapaneseMarkers，识别并提取标记中的日语部分
- [x] 创建RichTextWithJapanese组件，将日语部分套用TranslatableText组件
- [x] 在KnowledgeExpansion组件中使用RichTextWithJapanese渲染知识扩展内容
- [x] 测试hover翻译功能 - 11个解析器测试通过


## Bug修复 - 知识扩展日语标记显示问题 (已完成)
- [x] 修复{{JP}}和{{/JP}}标记直接显示在页面上的问题 - 重写RichTextWithJapanese组件
- [x] 确保日语部分使用与场景描述相同的TranslatableText样式 - 场景应用的example和expression也使用RichTextWithJapanese
- [x] 测试修复效果 - 19个测试通过


## Bug修复 - 知识扩展显示问题 (已完成)
- [x] 修复场景变体explanation中{{JP}}标签未被处理的问题 - 使用RichTextWithJapanese组件
- [x] 修复已有知识扩展内容时默认展开显示 - 使用useEffect检查缓存并自动展开
- [x] 测试修复效果 - 19个测试通过


## UI优化 - 翻译按钮定位 (已完成)
- [x] 修改翻译按钮为绝对定位，不占用文档流中的实际位置 - 使用absolute定位
- [x] 测试修复效果

## UI优化 - 翻译按钮可见度 (已完成)
- [x] 修改翻译按钮样式，增加白色背景和明显边框使其在白色背景上更清晰可见
- [x] 测试修复效果

## UI优化 - 翻译按钮位置调整 (已完成)
- [x] 调整翻译按钮位置到原文的左下角 - 使用-left-6 bottom-0 translate-y-1/2
- [x] 测试修复效果

## UI优化 - 翻译按钮位置调整 (已完成)
- [x] 调整翻译按钮位置到句末的右下角 - 使用-right-1 -bottom-1
- [x] 测试修复效果

## UI优化 - 翻译交互重新设计 (已完成)
- [x] 移除翻译按钮，改用虚线下划线标识可翻译日语
- [x] 点击日语文本展开/收起翻译弹窗
- [x] 弹窗增加关闭按钮 - 始终显示在右上角
- [x] 测试修复效果

## UI优化 - 统一虚线下划线样式 (已完成)
- [x] 场景描述中的日语文本添加虚线下划线 - 修改ClickableJapaneseText组件
- [x] 对话内容中的日语文本添加虚线下划线 - 同上
- [x] 测试修复效果

## Bug修复 - 虚线下划线宽度问题 (已完成)
- [x] 修复虚线下划线延伸到整个容器宽度的问题 - 将div改为span并使用inline
- [x] 让下划线只跟随文字内容的宽度
- [x] 测试修复效果

## UI优化 - 翻译图标更换 (已完成)
- [x] 将中文翻译前的国旗图标换成Languages图标
- [x] 测试修复效果

## Bug修复 - 中日文字体显示问题 (已完成)
- [x] 添加中文字体（Noto Sans SC） - 已在index.html中配置
- [x] 配置中文内容使用中文字体，日语内容使用日语字体 - body默认使用Noto Sans SC，.japanese-text使用Noto Sans JP
- [x] 测试修复效果

## Bug修复 - 标点符号导致注音错位 (已完成)
- [x] 修复分词器在遇到标点符号时的分割逻辑 - 标点符号始终单独分割
- [x] 测试修复效果

## Bug修复 - 注音显示在标点符号上 (已完成)
- [x] 修复注音对齐逻辑，确保标点不显示注音 - 添加cleanReading函数过滤标点
- [x] 测试修复效果

## 功能优化 - 注音数据本地缓存 (待实现)
- [ ] 创建注音缓存管理器（使用localStorage）
- [ ] 修改AutoRuby组件使用缓存
- [ ] 添加缓存过期机制
- [ ] 测试缓存功能

## 优化 - 区分发音标点和断句标点 (已完成)
- [x] 修改cleanReading函数，保留长音符号（ー）和中点（・）等对发音有影响的符号
- [x] 只过滤断句标点（句号、顿号、问号等）
- [x] 测试修复效果
